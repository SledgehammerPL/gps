<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Historia GPS ze ścieżką i korektą dryfu + satelity</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 80vh; width: 100vw; }
    #panel { padding: 8px 12px; background: #f5f5f5; border-top: 1px solid #ddd; display:flex; align-items:center; gap:10px; }
    #panel span { margin-right: 20px; }
    button { margin-right: 10px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <button id="btnStart">Start</button>
    <button id="btnPause">Pauza</button>
    <button id="btnResume">Wznów</button>
    <span id="status">Ładowanie…</span>
    <span id="progress"></span>
  </div>

  <script>
    var map = L.map('map').setView([50.25854, 18.96594], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22 }).addTo(map);

    var markers = {};
    var polylines = {};
    var paths = {};
    var records = [];
    var idx = 0;
    var intervalId = null;
    var stepMs = 150;

    // Korekta dryfu
    var referencePoint = null;   // współrzędna wzorcowa (player_id=2)
    var referenceSats = 0;       // liczba satelitów dla wzorca
    var driftCorrection = {lat:0, lon:0};

    function colorForPlayer(id) {
      var colors = ['red', 'blue', 'green', 'orange', 'purple', 'brown', 'black'];
      var i = parseInt(id, 10);
      if (isNaN(i)) i = 0;
      return colors[i % colors.length];
    }

    fetch('history.php')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) {
          alert("Nie przyszła tablica JSON:\n" + JSON.stringify(data, null, 2));
          document.getElementById('status').textContent = 'Błędny format danych';
          return;
        }


        document.getElementById('status').textContent = 'Pobrano ' + data.length + ' rekordów';

        records = data.filter(d =>
          d && d.latitude != null && d.longitude != null && d.player_id != null
        ).map(d => ({
          latitude: Number(d.latitude),
          longitude: Number(d.longitude),
          player_id: d.player_id,
          timestamp: d.timestamp,
          id: d.id,
          sats: d.sats ? Number(d.sats) : 0   // liczba satelitów
        }));

        if (records.length === 0) {
          document.getElementById('status').textContent = 'Brak poprawnych danych do animacji';
          return;
        }

        var pts = records.map(d => [d.latitude, d.longitude]);
        var bounds = L.latLngBounds(pts);
        map.fitBounds(bounds.pad(0.2));

        document.getElementById('status').textContent = 'Gotowe do odtwarzania (' + records.length + ' rekordów)';
        updateProgress();
      })
      .catch(err => {
        console.error('Fetch/JSON error:', err);
        document.getElementById('status').textContent = 'Błąd pobierania danych';
      });

    function updateProgress() {
      var p = document.getElementById('progress');
      p.textContent = 'Krok: ' + idx + ' / ' + records.length;
    }

    function step() {
      if (idx >= records.length) {
        if (intervalId) { clearInterval(intervalId); intervalId = null; }
        document.getElementById('status').textContent = 'Zakończono odtwarzanie';
        updateProgress();
        return;
      }

      var item = records[idx];
      if (!item) { idx++; updateProgress(); return; }

      var lat = item.latitude;
      var lon = item.longitude;
      var id  = item.player_id;
      var sats = item.sats || 0;

      // Korekta dryfu z uwzględnieniem satelitów
      if (id == 0) {
        if (!referencePoint) {
          referencePoint = {lat: lat, lon: lon};
          referenceSats = sats;
          driftCorrection = {lat:0, lon:0};
        } else {
          // jeśli nowa współrzędna ma więcej satelitów niż dotychczasowy wzorzec -> aktualizuj
          if (sats > referenceSats) {
            referencePoint = {lat: lat, lon: lon};
            referenceSats = sats;
            driftCorrection = {lat:0, lon:0};
          } else {
            driftCorrection = {
              lat: lat - referencePoint.lat,
              lon: lon - referencePoint.lon
            };
          }
        }
        lat = referencePoint.lat;
        lon = referencePoint.lon;
      } else if (id != 0 && referencePoint) {
        lat = lat - driftCorrection.lat;
        lon = lon - driftCorrection.lon;
      }

      var point = [lat, lon];

      if (!markers[id]) {
        markers[id] = L.circleMarker(point, {
          radius: 6,
          color: colorForPlayer(id),
          fillColor: colorForPlayer(id),
          fillOpacity: 0.85,
          weight: 1
        }).addTo(map).bindPopup('Player ' + id);
      } else {
        markers[id].setLatLng(point);
      }

      if (!paths[id]) paths[id] = [];
      paths[id].push(point);

      if (!polylines[id]) {
        polylines[id] = L.polyline(paths[id], {
          color: colorForPlayer(id),
          weight: 2,
          opacity: 0.7
        }).addTo(map);
      } else {
        polylines[id].setLatLngs(paths[id]);
      }

      idx++;
      updateProgress();
    }

    document.getElementById('btnStart').addEventListener('click', function() {
      if (records.length === 0) return;
      if (intervalId) { clearInterval(intervalId); intervalId = null; }
      idx = 0;
      referencePoint = null;
      referenceSats = 0;
      driftCorrection = {lat:0, lon:0};
      intervalId = setInterval(step, stepMs);
      document.getElementById('status').textContent = 'Odtwarzanie…';
      updateProgress();
    });

    document.getElementById('btnPause').addEventListener('click', function() {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
        document.getElementById('status').textContent = 'Wstrzymano';
      }
    });

    document.getElementById('btnResume').addEventListener('click', function() {
      if (!intervalId && records.length > 0 && idx < records.length) {
        intervalId = setInterval(step, stepMs);
        document.getElementById('status').textContent = 'Odtwarzanie…';
      }
    });
  </script>
</body>
</html>

