<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Analiza GPS — Poprawiona stabilność</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    #main-container { display: flex; flex: 1; overflow: hidden; }
    #map { flex: 1; height: 100%; }
    #sidebar { width: 330px; background: #2c3e50; color: white; display: flex; flex-direction: column; border-left: 3px solid #1a252f; }
    #controls { padding: 15px; background: #1a252f; border-bottom: 1px solid #34495e; }
    .btn-group { display: flex; gap: 5px; margin-bottom: 12px; }
    button { flex: 1; padding: 10px; cursor: pointer; border: none; border-radius: 3px; font-weight: bold; background: #3498db; color: white; }
    #btnStart { background: #2ecc71; }
    select { width: 100%; padding: 8px; border-radius: 4px; background: #34495e; color: white; border: 1px solid #555; margin-bottom: 10px;}
    #playerList { flex: 1; overflow-y: auto; padding: 15px; }
    .player-row { padding: 10px; margin-bottom: 8px; border-radius: 5px; background: #34495e; font-size: 0.85em; }
    .active-player { border-left: 5px solid #2ecc71; background: #3d566e; }
    .ref-header { color: #f1c40f; font-weight: bold; border-left: 5px solid #f1c40f; padding-left: 5px; }
    .stat-val { font-weight: bold; color: #2ecc71; }
  </style>
</head>
<body>

  <div id="main-container">
    <div id="map"></div>
    <div id="sidebar">
      <div id="controls">
        <div class="btn-group">
          <button id="btnStart">START</button>
          <button id="btnPause">PAUZA</button>
        </div>
        <label style="font-size: 0.75em; color: #bdc3c7;">Widok Heatmapy:</label>
        <select id="heatSwitch"><option value="all">Wszyscy Zawodnicy</option></select>
        <div style="font-size: 0.8em;">
            Status: <span id="status">Ładowanie...</span><br>
            Postęp: <span id="progress">0 / 0</span>
        </div>
      </div>
      <div id="playerList"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
  var map = L.map('map').setView([50.25854,18.96594], 19);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:22}).addTo(map);

  var heatLayer = L.heatLayer([], {radius: 15, blur: 10}).addTo(map);
  var markers={}, polylines={}, paths={}, records=[];
  var heatData = { all: [] };
  var idx=0, intervalId=null;

  // Statystyki
  var lastPoints={}, speeds={}, distances={}, maxSpeeds={};
  var driftMap = []; 
  var validReferenceIndices = []; 

  const urlParams = new URLSearchParams(window.location.search);
  const refId = parseInt(urlParams.get("ref")) || 0;

  function colorForPlayer(id){
    var colors=['#e74c3c','#3498db','#2ecc71','#f1c40f','#9b59b6','#e67e22','#1abc9c','#f39c12','#95a5a6','#7f8c8d','#c0392b'];
    return colors[id % colors.length];
  }

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // Funkcja bezpiecznego tworzenia UI dla zawodnika
  function ensurePlayerUI(id) {
    if (!document.getElementById(`player-row-${id}`)) {
      const div = document.createElement('div');
      div.className = 'player-row' + (id == refId ? ' ref-header' : '');
      div.id = `player-row-${id}`;
      div.innerHTML = `<b>${id == refId ? 'BAZA (REF)' : 'ZAWODNIK ' + id}</b><div id="stats-${id}">Aktywny...</div>`;
      document.getElementById('playerList').appendChild(div);
      
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = `Zawodnik ${id}`;
      document.getElementById('heatSwitch').appendChild(opt);
      
      if (!heatData[id]) heatData[id] = [];
    }
  }

  fetch('history.php').then(r=>r.json()).then(data=>{
    records = data.map(d => ({
      lat: parseFloat(d.latitude), lon: parseFloat(d.longitude),
      id: parseInt(d.player_id), sats: parseInt(d.sats || 0),
      t: new Date(d.timestamp).getTime()
    })).sort((a, b) => a.t - b.t);

    // Inicjalizacja UI dla znanych ID
    const uniqueIds = [...new Set(records.map(r => r.id))];
    uniqueIds.forEach(id => ensurePlayerUI(id));

    let bestRef = records.filter(r => r.id === refId).reduce((prev, curr) => (curr.sats > prev.sats ? curr : prev), {sats: -1});
    if (bestRef.sats === -1) bestRef = records.find(r => r.id === refId) || records[0];
    
    const basePos = { lat: bestRef.lat, lon: bestRef.lon };

    let currentDrift = null;
    driftMap = records.map((r, i) => {
      if (r.id === refId) {
        currentDrift = { lat: r.lat - basePos.lat, lon: r.lon - basePos.lon };
      }
      if (currentDrift !== null) validReferenceIndices.push(i);
      return currentDrift ? { ...currentDrift } : null;
    });

    document.getElementById('status').textContent = "Gotowe";
    document.getElementById('progress').textContent = `0 / ${records.length}`;
  });

  function step(){
    if(idx >= records.length){ clearInterval(intervalId); return; }
    if (!validReferenceIndices.includes(idx)) { idx++; return; }

    const item = records[idx];
    const drift = driftMap[idx];
    const point = [item.lat - drift.lat, item.lon - drift.lon];

    // Zabezpieczenie przed brakiem tablicy (to naprawia Twój błąd)
    if (!heatData[item.id]) heatData[item.id] = [];
    
    // Statystyki
    if (item.id !== refId) {
        if (lastPoints[item.id]) {
            let dt = (item.t - lastPoints[item.id].t) / 1000;
            if (dt > 0) {
                let dist = haversine(lastPoints[item.id].lat, lastPoints[item.id].lon, point[0], point[1]);
                let speedKmh = (dist / dt) * 3.6;
                if (speedKmh < 100) {
                    distances[item.id] = (distances[item.id] || 0) + dist;
                    speeds[item.id] = speedKmh;
                    if (!maxSpeeds[item.id] || speedKmh > maxSpeeds[item.id]) maxSpeeds[item.id] = speedKmh;
                }
            }
        }
        lastPoints[item.id] = { lat: point[0], lon: point[1], t: item.t };
    }

    // Rysowanie
    if(!markers[item.id]){
      markers[item.id] = L.circleMarker(point, {radius: item.id==refId?7:4, color: colorForPlayer(item.id), fillOpacity: 1}).addTo(map);
    } else markers[item.id].setLatLng(point);

    if(!paths[item.id]) paths[item.id] = [];
    paths[item.id].push(point);
    if(!polylines[item.id]){
      polylines[item.id] = L.polyline(paths[item.id], {color: colorForPlayer(item.id), weight: 2, opacity: 0.5}).addTo(map);
    } else polylines[item.id].setLatLngs(paths[item.id]);

    // Heatmapa
    heatData.all.push([...point, 0.5]);
    heatData[item.id].push([...point, 0.5]);
    
    const hv = document.getElementById('heatSwitch').value;
    if (hv === 'all' || hv == item.id) heatLayer.setLatLngs(heatData[hv]);

    // UI
    document.querySelectorAll('.player-row').forEach(el => el.classList.remove('active-player'));
    const row = document.getElementById(`player-row-${item.id}`);
    if(row) {
        row.classList.add('active-player');
        const sDiv = document.getElementById(`stats-${item.id}`);
        if (item.id !== refId) {
            sDiv.innerHTML = `V: <span class="stat-val">${(speeds[item.id]||0).toFixed(1)} km/h</span> | Max: <span class="stat-val">${(maxSpeeds[item.id]||0).toFixed(1)}</span><br>Dystans: ${((distances[item.id]||0)/1000).toFixed(3)} km`;
        }
    }

    idx++;
    document.getElementById('progress').textContent = `${idx} / ${records.length}`;
  }

  document.getElementById('btnStart').addEventListener('click', function(){
    if(records.length === 0) return;
    clearInterval(intervalId); idx = 0;
    heatLayer.setLatLngs([]);
    Object.values(markers).forEach(m => map.removeLayer(m));
    Object.values(polylines).forEach(p => map.removeLayer(p));
    markers = {}; polylines = {}; paths = {};
    Object.keys(heatData).forEach(k => heatData[k] = []);
    lastPoints = {}; speeds = {}; distances = {}; maxSpeeds = {};
    intervalId = setInterval(step, 40);
  });

  document.getElementById('btnPause').addEventListener('click', () => clearInterval(intervalId));
  document.getElementById('heatSwitch').addEventListener('change', function() {
      heatLayer.setLatLngs(heatData[this.value] || []);
  });
</script>
</body>
</html>
