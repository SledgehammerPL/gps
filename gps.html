<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Historia GPS — Korekta Dynamiczna</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    #main-container { display: flex; flex: 1; height: 100%; overflow: hidden; }
    #map { flex: 1; height: 100%; }
    #sidebar { width: 320px; background: #2c3e50; color: white; display: flex; flex-direction: column; border-left: 3px solid #1a252f; }
    #controls { padding: 15px; background: #1a252f; border-bottom: 1px solid #34495e; }
    .btn-group { display: flex; gap: 5px; margin-bottom: 12px; }
    button { flex: 1; padding: 8px 5px; cursor: pointer; border: none; border-radius: 3px; font-weight: bold; background: #3498db; color: white; }
    button:hover { background: #2980b9; }
    #btnStart { background: #2ecc71; }
    select { width: 100%; padding: 8px; border-radius: 4px; background: #34495e; color: white; border: 1px solid #555; margin-top: 5px;}
    #playerList { flex: 1; overflow-y: auto; padding: 15px; }
    .player-row { padding: 10px; margin-bottom: 8px; border-radius: 5px; background: #34495e; font-size: 0.85em; }
    .active-player { border-left: 5px solid #2ecc71; }
    .ref-player { border-left: 5px solid #f1c40f; }
  </style>
</head>
<body>

  <div id="main-container">
    <div id="map"></div>
    <div id="sidebar">
      <div id="controls">
        <div class="btn-group">
          <button id="btnStart">START</button>
          <button id="btnPause">Pauza</button>
          <button id="btnResume">Wznów</button>
        </div>
        <label style="font-size: 0.75em; color: #bdc3c7;">Heatmapa:</label>
        <select id="heatSwitch"><option value="all">Wszyscy</option></select>
        <div style="font-size: 0.8em; margin-top:10px;">
            Status: <span id="status">Ładowanie...</span><br>
            <span id="progress"></span>
        </div>
      </div>
      <div id="playerList"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
  var map = L.map('map').setView([50.25854,18.96594],18);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:22}).addTo(map);

  var heatLayer = L.heatLayer([], {radius: 15, blur: 10, max: 1.0}).addTo(map);
  var markers={}, polylines={}, paths={}, records=[];
  var heatData = { all: [] };
  var idx=0, intervalId=null, stepMs=100;

  const refId = parseInt(new URL(window.location.href).searchParams.get("ref")) || 0;
  const correctionEnabled = (new URL(window.location.href).searchParams.get("correction") !== "no");

  var referencePoint=null, referenceSats=-1, drift={lat:0,lon:0};
  var lastPoints={}, speeds={}, distances={}, maxSpeeds={};

  // Inicjalizacja UI
  for(let i=1; i<=11; i++) {
      const div = document.createElement('div');
      div.className = 'player-row' + (i == refId ? ' ref-player' : '');
      div.id = `player-row-${i}`;
      div.innerHTML = `<div style="display:flex; justify-content:space-between"><b>${i==refId?'BAZA (REF)': 'ZAWODNIK '+i}</b><span style="color:${colorForPlayer(i)}">●</span></div><div id="stats-${i}">Brak danych</div>`;
      document.getElementById('playerList').appendChild(div);
      const opt = document.createElement('option'); opt.value = i; opt.textContent = `Zawodnik ${i}`;
      document.getElementById('heatSwitch').appendChild(opt);
      heatData[i] = [];
  }

  function colorForPlayer(id){
    var colors=['#e74c3c','#3498db','#2ecc71','#f1c40f','#9b59b6','#e67e22','#1abc9c','#f39c12','#95a5a6','#7f8c8d','#c0392b'];
    return colors[(id-1) % colors.length];
  }

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  document.getElementById('heatSwitch').addEventListener('change', () => heatLayer.setLatLngs(heatData[document.getElementById('heatSwitch').value]));

  fetch('history.php').then(r=>r.json()).then(data=>{
    records = data.map(d=>({
      latitude: Number(d.latitude), longitude: Number(d.longitude),
      player_id: parseInt(d.player_id), sats: d.sats ? Number(d.sats) : 0,
      timestamp: d.timestamp
    }));
    if(records.length > 0) {
        map.fitBounds(L.latLngBounds(records.map(d=>[d.latitude,d.longitude])).pad(0.1));
        document.getElementById('status').textContent = 'Gotowe';
    }
  });

  function step(){
    if(idx >= records.length){ clearInterval(intervalId); return; }

    var item = records[idx];
    var lat=item.latitude, lon=item.longitude, id=item.player_id, sats=item.sats||0;
    var t = new Date(item.timestamp).getTime();

    // --- LOGIKA KOREKTY GPS ---
    if(correctionEnabled){
        if(id == refId){
            // Jeśli stacja ma lepszy lub taki sam sygnał, aktualizujemy punkt zerowy
            if(!referencePoint || sats >= referenceSats){
                referencePoint = {lat: lat, lon: lon};
                referenceSats = sats;
            }
            // Obliczamy dryf względem obecnego punktu zerowego
            drift = {
                lat: lat - referencePoint.lat,
                lon: lon - referencePoint.lon
            };
        }
        // Wszystkich (łącznie ze stacją) korygujemy o wyliczony dryf
        if(referencePoint){
            lat = lat - drift.lat;
            lon = lon - drift.lon;
        }
    }

    // Obliczenia statystyk (tylko dla zawodników, nie dla bazy)
    if(lastPoints[id] && id != refId){
      var dt = (t - lastPoints[id].time) / 1000;
      if(dt > 0){
        var dist = haversine(lastPoints[id].lat, lastPoints[id].lon, lat, lon);
        var speedKmh = (dist / dt) * 3.6;
        if(speedKmh < 100) { // filtr błędów
            speeds[id] = speedKmh;
            distances[id] = (distances[id]||0) + dist;
            if(!maxSpeeds[id] || speedKmh > maxSpeeds[id]) maxSpeeds[id] = speedKmh;
        }
      }
    }
    lastPoints[id] = {lat:lat, lon:lon, time:t};

    // Heatmapa i Rysowanie
    const currentPoint = [lat, lon];
    heatData.all.push([...currentPoint, 0.5]);
    if(heatData[id]) heatData[id].push([...currentPoint, 0.5]);
    if(document.getElementById('heatSwitch').value == 'all' || document.getElementById('heatSwitch').value == id) {
        heatLayer.setLatLngs(heatData[document.getElementById('heatSwitch').value]);
    }

    // Update UI
    const sDiv = document.getElementById(`stats-${id}`);
    if(sDiv) {
        document.getElementById(`player-row-${id}`).classList.add('active-player');
        if(id == refId) sDiv.innerHTML = `<span style="color:#f1c40f">SAT: ${sats} | Pozycja ustalona</span>`;
        else sDiv.innerHTML = `V: ${speeds[id] ? speeds[id].toFixed(1) : 0} km/h | Max: <b>${maxSpeeds[id] ? maxSpeeds[id].toFixed(1) : 0}</b><br>Dyst: ${(distances[id]/1000).toFixed(3)} km`;
    }

    if(!markers[id]){
      markers[id] = L.circleMarker(currentPoint, {radius: id==refId?7:5, color: colorForPlayer(id), fillOpacity: 1}).addTo(map);
    } else markers[id].setLatLng(currentPoint);

    if(!paths[id]) paths[id] = [];
    paths[id].push(currentPoint);
    if(!polylines[id]){
      polylines[id] = L.polyline(paths[id], {color: colorForPlayer(id), weight: id==refId?1:2, opacity: 0.4}).addTo(map);
    } else polylines[id].setLatLngs(paths[id]);

    idx++;
    document.getElementById('progress').textContent = idx + ' / ' + records.length;
  }

  document.getElementById('btnStart').addEventListener('click', function(){
    if(records.length === 0) return;
    clearInterval(intervalId); idx = 0;
    Object.keys(heatData).forEach(k => heatData[k] = []);
    heatLayer.setLatLngs([]);
    referencePoint = null; referenceSats = -1; drift = {lat:0,lon:0};
    lastPoints = {}; speeds = {}; distances = {}; maxSpeeds = {};
    Object.keys(polylines).forEach(p => map.removeLayer(polylines[p])); polylines = {}; paths = {};
    Object.keys(markers).forEach(m => map.removeLayer(markers[m])); markers = {};
    document.querySelectorAll('.player-row').forEach(r => r.classList.remove('active-player'));
    intervalId = setInterval(step, stepMs);
  });

  document.getElementById('btnPause').addEventListener('click', () => { clearInterval(intervalId); intervalId = null; });
  document.getElementById('btnResume').addEventListener('click', () => { if(!intervalId && idx < records.length) intervalId = setInterval(step, stepMs); });
</script>
</body>
</html>
